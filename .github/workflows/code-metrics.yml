name: ğŸ“Š Code Quality & Metrics Analysis

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
  schedule:
    # Ejecutar todos los lunes a las 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      complexity_threshold:
        description: 'Umbral de complejidad ciclomÃ¡tica'
        required: false
        default: '10'
        type: string
      generate_report:
        description: 'Generar reporte HTML'
        required: false
        default: true
        type: boolean

jobs:
  code-metrics:
    name: ğŸ” AnÃ¡lisis de MÃ©tricas de CÃ³digo
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      checks: write
      pull-requests: write
      pages: write
      id-token: write
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necesario para anÃ¡lisis de SonarQube
    
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: ğŸ“¦ Restaurar dependencias
      run: dotnet restore CarritoCompras.sln
      working-directory: ./
    
    - name: ğŸ—ï¸ Build proyecto
      run: dotnet build CarritoCompras.sln --no-restore --configuration Release
      working-directory: ./
    
    - name: ğŸ§ª Ejecutar tests con cobertura
      run: |
        dotnet test CarritoCompras.sln \
          --no-build \
          --configuration Release \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults \
          --logger trx \
          --verbosity minimal
      working-directory: ./
    
    - name: ğŸ“Š Instalar ReportGenerator
      run: dotnet tool install -g dotnet-reportgenerator-globaltool
    
    - name: ğŸ“ˆ Generar reporte de cobertura
      run: |
        reportgenerator \
          -reports:"./TestResults/**/coverage.cobertura.xml" \
          -targetdir:"./coverage-report" \
          -reporttypes:"Html;JsonSummary;Badges;MarkdownSummaryGithub" \
          -title:"Carrito Compras - Cobertura de CÃ³digo"
      working-directory: ./
    
    - name: ğŸ“Š Obtener mÃ©tricas de cobertura
      id: coverage
      run: |
        if [ -f "./coverage-report/Summary.json" ]; then
          COVERAGE=$(jq -r '.summary.linecoverage' ./coverage-report/Summary.json)
          BRANCH_COVERAGE=$(jq -r '.summary.branchcoverage' ./coverage-report/Summary.json)
          echo "line_coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "branch_coverage=$BRANCH_COVERAGE" >> $GITHUB_OUTPUT
          echo "âœ… Cobertura de lÃ­neas: $COVERAGE%"
          echo "âœ… Cobertura de ramas: $BRANCH_COVERAGE%"
        else
          echo "âš ï¸ Archivo de resumen de cobertura no encontrado"
          echo "line_coverage=0" >> $GITHUB_OUTPUT
          echo "branch_coverage=0" >> $GITHUB_OUTPUT
        fi
      working-directory: ./
    
    - name: ğŸ” Iniciar aplicaciÃ³n para mÃ©tricas
      run: |
        # Iniciar aplicaciÃ³n en background
        cd backend/src/CarritoComprasAPI
        dotnet run --no-build --configuration Release --urls http://localhost:5000 &
        APP_PID=$!
        echo "APP_PID=$APP_PID" >> $GITHUB_ENV
        
        # Esperar que la aplicaciÃ³n inicie
        echo "â³ Esperando que la aplicaciÃ³n inicie..."
        for i in {1..30}; do
          if curl -s http://localhost:5000/api/metrics/report > /dev/null; then
            echo "âœ… AplicaciÃ³n iniciada correctamente"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "âŒ Timeout esperando que la aplicaciÃ³n inicie"
            exit 1
          fi
          sleep 2
        done
      working-directory: ./
    
    - name: ğŸ“Š Obtener mÃ©tricas personalizadas
      id: custom_metrics
      run: |
        mkdir -p ./metrics-output
        
        # Obtener reporte completo de mÃ©tricas
        curl -s http://localhost:5000/api/metrics/report > ./metrics-output/full-report.json
        
        # Obtener complejidad ciclomÃ¡tica
        curl -s http://localhost:5000/api/metrics/cyclomatic-complexity > ./metrics-output/complexity.json
        
        # Obtener deuda tÃ©cnica
        curl -s http://localhost:5000/api/metrics/technical-debt > ./metrics-output/technical-debt.json
        
        # Obtener resumen ejecutivo
        curl -s http://localhost:5000/api/metrics/executive-summary > ./metrics-output/executive-summary.json
        
        # Extraer mÃ©tricas clave
        if [ -f "./metrics-output/complexity.json" ]; then
          AVG_COMPLEXITY=$(jq -r '.averageComplexity' ./metrics-output/complexity.json)
          HIGH_COMPLEXITY_COUNT=$(jq -r '.highComplexityMethods | length' ./metrics-output/complexity.json)
          echo "avg_complexity=$AVG_COMPLEXITY" >> $GITHUB_OUTPUT
          echo "high_complexity_methods=$HIGH_COMPLEXITY_COUNT" >> $GITHUB_OUTPUT
          echo "âœ… Complejidad promedio: $AVG_COMPLEXITY"
          echo "âœ… MÃ©todos de alta complejidad: $HIGH_COMPLEXITY_COUNT"
        fi
        
        if [ -f "./metrics-output/technical-debt.json" ]; then
          DEBT_HOURS=$(jq -r '.totalDebtHours' ./metrics-output/technical-debt.json)
          DEBT_SEVERITY=$(jq -r '.severityLevel' ./metrics-output/technical-debt.json)
          echo "debt_hours=$DEBT_HOURS" >> $GITHUB_OUTPUT
          echo "debt_severity=$DEBT_SEVERITY" >> $GITHUB_OUTPUT
          echo "âœ… Deuda tÃ©cnica: $DEBT_HOURS horas ($DEBT_SEVERITY)"
        fi
      working-directory: ./
    
    - name: ğŸ›‘ Detener aplicaciÃ³n
      if: always()
      run: |
        if [ ! -z "$APP_PID" ]; then
          kill $APP_PID || true
          echo "ğŸ›‘ AplicaciÃ³n detenida"
        fi
      working-directory: ./
    
    - name: ğŸ·ï¸ Generar badges de mÃ©tricas
      run: |
        mkdir -p ./badges
        
        # Badge de cobertura
        COVERAGE="${{ steps.coverage.outputs.line_coverage }}"
        COLOR="red"
        if (( $(echo "$COVERAGE >= 80" | bc -l) )); then COLOR="brightgreen"
        elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then COLOR="yellow"
        elif (( $(echo "$COVERAGE >= 40" | bc -l) )); then COLOR="orange"
        fi
        
        curl -s "https://img.shields.io/badge/Cobertura-${COVERAGE}%25-${COLOR}" > ./badges/coverage.svg
        
        # Badge de complejidad
        COMPLEXITY="${{ steps.custom_metrics.outputs.avg_complexity }}"
        COMPLEXITY_COLOR="red"
        if (( $(echo "$COMPLEXITY <= 5" | bc -l) )); then COMPLEXITY_COLOR="brightgreen"
        elif (( $(echo "$COMPLEXITY <= 10" | bc -l) )); then COMPLEXITY_COLOR="yellow"
        elif (( $(echo "$COMPLEXITY <= 15" | bc -l) )); then COMPLEXITY_COLOR="orange"
        fi
        
        curl -s "https://img.shields.io/badge/Complejidad-${COMPLEXITY}-${COMPLEXITY_COLOR}" > ./badges/complexity.svg
        
        # Badge de deuda tÃ©cnica
        DEBT_SEVERITY="${{ steps.custom_metrics.outputs.debt_severity }}"
        DEBT_COLOR="red"
        case $DEBT_SEVERITY in
          "Baja") DEBT_COLOR="brightgreen" ;;
          "Moderada") DEBT_COLOR="yellow" ;;
          "Alta") DEBT_COLOR="orange" ;;
          "CrÃ­tica") DEBT_COLOR="red" ;;
        esac
        
        curl -s "https://img.shields.io/badge/Deuda%20TÃ©cnica-${DEBT_SEVERITY}-${DEBT_COLOR}" > ./badges/debt.svg
      working-directory: ./
    
    - name: ğŸ“ Comentar resultados en PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = '${{ steps.coverage.outputs.line_coverage }}';
          const branchCoverage = '${{ steps.coverage.outputs.branch_coverage }}';
          const avgComplexity = '${{ steps.custom_metrics.outputs.avg_complexity }}';
          const highComplexityMethods = '${{ steps.custom_metrics.outputs.high_complexity_methods }}';
          const debtHours = '${{ steps.custom_metrics.outputs.debt_hours }}';
          const debtSeverity = '${{ steps.custom_metrics.outputs.debt_severity }}';
          
          const complexityThreshold = '${{ github.event.inputs.complexity_threshold }}' || '10';
          
          // Determinar emojis y colores basados en mÃ©tricas
          const coverageEmoji = parseFloat(coverage) >= 80 ? 'âœ…' : parseFloat(coverage) >= 60 ? 'âš ï¸' : 'âŒ';
          const complexityEmoji = parseFloat(avgComplexity) <= 10 ? 'âœ…' : parseFloat(avgComplexity) <= 15 ? 'âš ï¸' : 'âŒ';
          const debtEmoji = debtSeverity === 'Baja' ? 'âœ…' : debtSeverity === 'Moderada' ? 'âš ï¸' : 'âŒ';
          
          const comment = `
          ## ğŸ“Š Reporte de MÃ©tricas de CÃ³digo
          
          | MÃ©trica | Valor | Estado |
          |---------|-------|--------|
          | **Cobertura de LÃ­neas** | ${coverage}% | ${coverageEmoji} |
          | **Cobertura de Ramas** | ${branchCoverage}% | ${coverageEmoji} |
          | **Complejidad Promedio** | ${avgComplexity} | ${complexityEmoji} |
          | **MÃ©todos Complejos (>${complexityThreshold})** | ${highComplexityMethods} | ${highComplexityMethods == 0 ? 'âœ…' : 'âš ï¸'} |
          | **Deuda TÃ©cnica** | ${debtHours}h (${debtSeverity}) | ${debtEmoji} |
          
          ### ğŸ¯ Objetivos de Calidad
          - **Cobertura objetivo:** â‰¥80%
          - **Complejidad objetivo:** â‰¤10
          - **Deuda tÃ©cnica objetivo:** â‰¤Moderada
          
          ### ğŸ“ˆ Recomendaciones
          ${parseFloat(coverage) < 80 ? '- â¬†ï¸ Aumentar cobertura de tests\n' : ''}
          ${parseFloat(avgComplexity) > 10 ? '- ğŸ”§ Refactorizar mÃ©todos complejos\n' : ''}
          ${parseInt(highComplexityMethods) > 0 ? `- âš ï¸ Revisar ${highComplexityMethods} mÃ©todos con alta complejidad\n` : ''}
          ${debtSeverity !== 'Baja' ? '- ğŸ’³ Reducir deuda tÃ©cnica\n' : ''}
          
          <details>
          <summary>ğŸ” Ver reportes detallados</summary>
          
          - [ğŸ“Š Reporte de Cobertura](../coverage-report/index.html)
          - [ğŸ“ˆ AnÃ¡lisis de Complejidad](../metrics-output/complexity.json)
          - [ğŸ’³ Deuda TÃ©cnica](../metrics-output/technical-debt.json)
          
          </details>
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: ğŸ“¤ Subir artefactos
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-metrics-report-${{ github.run_number }}
        path: |
          ./coverage-report/
          ./metrics-output/
          ./badges/
          ./TestResults/
        retention-days: 30
    
    - name: ğŸ“Š Setup Pages (solo en main)
      if: github.ref == 'refs/heads/main'
      uses: actions/configure-pages@v4
    
    - name: ğŸŒ Deploy a GitHub Pages (solo en main)
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-pages-artifact@v3
      with:
        path: './coverage-report'
    
    - name: ğŸš€ Publicar Pages (solo en main)
      if: github.ref == 'refs/heads/main'
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: âŒ Fallar si mÃ©tricas crÃ­ticas
      run: |
        echo "ğŸ” Evaluando mÃ©tricas crÃ­ticas..."
        
        COVERAGE="${{ steps.coverage.outputs.line_coverage }}"
        COMPLEXITY="${{ steps.custom_metrics.outputs.avg_complexity }}"
        HIGH_COMPLEXITY="${{ steps.custom_metrics.outputs.high_complexity_methods }}"
        DEBT_SEVERITY="${{ steps.custom_metrics.outputs.debt_severity }}"
        
        FAIL=false
        
        # Verificar cobertura mÃ­nima (40%)
        if (( $(echo "$COVERAGE < 40" | bc -l) )); then
          echo "âŒ FALLO: Cobertura de cÃ³digo muy baja ($COVERAGE% < 40%)"
          FAIL=true
        fi
        
        # Verificar complejidad mÃ¡xima (20)
        if (( $(echo "$COMPLEXITY > 20" | bc -l) )); then
          echo "âŒ FALLO: Complejidad promedio muy alta ($COMPLEXITY > 20)"
          FAIL=true
        fi
        
        # Verificar mÃ©todos de alta complejidad (mÃ¡ximo 5)
        if [ "$HIGH_COMPLEXITY" -gt 5 ]; then
          echo "âŒ FALLO: Demasiados mÃ©todos de alta complejidad ($HIGH_COMPLEXITY > 5)"
          FAIL=true
        fi
        
        # Verificar deuda tÃ©cnica crÃ­tica
        if [ "$DEBT_SEVERITY" = "CrÃ­tica" ]; then
          echo "âŒ FALLO: Deuda tÃ©cnica crÃ­tica detectada"
          FAIL=true
        fi
        
        if [ "$FAIL" = true ]; then
          echo "ğŸ’¥ El build falla debido a mÃ©tricas crÃ­ticas de calidad"
          exit 1
        else
          echo "âœ… Todas las mÃ©tricas crÃ­ticas estÃ¡n dentro de los umbrales aceptables"
        fi
      working-directory: ./
    
    - name: ğŸ‰ Resumen final
      if: always()
      run: |
        echo "ğŸ¯ === RESUMEN DE MÃ‰TRICAS ==="
        echo "ğŸ“Š Cobertura: ${{ steps.coverage.outputs.line_coverage }}%"
        echo "ğŸ”„ Complejidad promedio: ${{ steps.custom_metrics.outputs.avg_complexity }}"
        echo "âš ï¸ MÃ©todos complejos: ${{ steps.custom_metrics.outputs.high_complexity_methods }}"
        echo "ğŸ’³ Deuda tÃ©cnica: ${{ steps.custom_metrics.outputs.debt_hours }}h (${{ steps.custom_metrics.outputs.debt_severity }})"
        echo "================================"
      working-directory: ./
